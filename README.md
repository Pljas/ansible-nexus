# Управление нодами Nexus с помощью Ansible

Этот проект предоставляет автоматизированные сценарии (плейбуки) Ansible для упрощения развертывания, настройки и управления нодами Nexus.

## Ключевые возможности

- **Подготовка системы**: Автоматически настраивает файл подкачки (swap) для обеспечения стабильной работы ноды.
- **Установка зависимостей**: Устанавливает Docker и все необходимые компоненты.
- **Управление контейнером**: Позволяет запускать, останавливать, обновлять и удалять контейнер с нодой Nexus.
- **Гибкая настройка**: Легко настраивается через файл инвентаризации для работы с несколькими нодами.

## Требования

### 1. Установка Python

**Linux (Ubuntu/Debian):**
```bash
sudo apt update && sudo apt install -y python3 python3-pip
```

**macOS (через Homebrew):**
```bash
brew install python3
```

### 2. Установка Ansible

```bash
pip3 install ansible
```
Для получения более подробной информации обратитесь к [официальной документации по установке Ansible](https://docs.ansible.com/ansible/latest/installation_guide/index.html).

### 3. Установка коллекций Ansible

Проект использует коллекции Ansible для управления Docker и системными компонентами. Установите их с помощью файла `requirements.yml`:

```bash
ansible-galaxy collection install -r requirements.yml
```

## Настройка

### 1. SSH-ключи

Для безопасного подключения к серверам рекомендуется использовать SSH-ключи.

**Создание ключа:**
```bash
ssh-keygen -t ed25519 -C "your_email@example.com"
```

**Копирование ключа на сервер:**
```bash
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@server_ip
```

### 2. Файл инвентаризации (`inventory`)

Откройте файл `inventory` и укажите данные для подключения к вашим серверам.

```ini
[nexus_nodes]
# Замените на ваши данные:
# 192.168.1.100 ansible_user=root node_id="ВАШ_NODE_ID" ansible_ssh_private_key_file=~/.ssh/id_ed25519

# Пример с ограничением ресурсов:
# 192.168.1.101 ansible_user=root node_id="ДРУГОЙ_ID" memory="1g" cpus="0.5"
```

**Параметры:**
- `192.168.1.100`: IP-адрес вашего сервера.
- `ansible_user`: Пользователь для подключения (`root`, `ubuntu` и т.д.).
- `node_id`: Уникальный идентификатор вашей ноды Nexus.
- `ansible_ssh_private_key_file`: Путь к вашему приватному SSH-ключу.
- `memory` (опционально): Ограничение по памяти (например, "1g", "512m").
- `cpus` (опционально): Ограничение по CPU (например, "1.0", "0.5").
- `max_threads` (опционально): Количество потоков для прувера (например, 6). Максимальное значение - 8.

## Использование

Плейбук разделен на теги для гранулярного управления задачами.

### Доступные теги

- `system`: Подготовка системы (настройка файла подкачки).
- `install`: Установка Docker и зависимостей.
- `start`: Запуск контейнера Nexus.
- `update`: Обновление и перезапуск контейнера.
- `stop`: Остановка и удаление контейнера.
- `attach`: Отображение команды для подключения к интерфейсу контейнера.

### Команды

**Полная установка и запуск:**
```bash
ansible-playbook playbook.yml --tags "system,install,start"
```

**Обновление контейнера:**
```bash
ansible-playbook playbook.yml --tags "update"
```

**Обновление до конкретной версии:**
```bash
ansible-playbook playbook.yml --tags "update" --extra-vars "nexus_version=1.2.3"
```

**Остановка и удаление контейнера:**
```bash
ansible-playbook playbook.yml --tags "stop"
```

### Опции подключения

- `--ask-pass`: Запрос пароля для SSH-подключения (если не используются ключи).
- `--ask-become-pass`: Запрос пароля для повышения привилегий (`sudo`).

## Устранение неисправностей

### Ошибка: `couldn't resolve module/action`
Это означает, что необходимые коллекции Ansible не установлены.
**Решение:**
```bash
ansible-galaxy collection install -r requirements.yml
```

### Ошибка: `'ansible_swaps' is undefined`
Возникает, если на сервере отсутствует файл подкачки. Плейбук уже содержит логику для обработки этого случая, но если ошибка все же появляется, убедитесь, что у вас последняя версия плейбука.

### Предупреждение: `world writable directory`
Проблема с правами доступа к директории проекта.
**Решение:**
```bash
chmod o-w /path/to/your/project
```

## Структура проекта

```
ansible-nexus/
├── ansible.cfg          # Конфигурация Ansible
├── inventory            # Список серверов и их переменные
├── playbook.yml         # Основной плейбук
├── requirements.yml     # Список коллекций Ansible
└── README.md            # Эта документация
```